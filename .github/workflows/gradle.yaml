name: CD

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
        
      - name: Build App
        run: ./gradlew bootJar

      - name: Deploy Prod use SCP
        uses: appleboy/scp-action@master
        with:
          username: ubuntu
          host: ${{ secrets.HOST }}
          key: ${{ secrets.PRIVATE_KEY }}
          source: "./server-api/build/libs/*.jar, ./server-batch/build/libs/*.jar"
          target: "/app/hotel-mono-reservation"
          strip_components: 2
          
#       - name: Transfer Deploy Script use SCP
#         uses: appleboy/scp-action@master
#         with:
#           username: ubuntu
#           host: ${{ secrets.HOST }}
#           key: ${{ secrets.PRIVATE_KEY }}
#           source: "deploy.sh"
#           target: "/home/ubuntu/deploy"

      - name: Execute Server Init Script
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.HOST }}
          key: ${{ secrets.PRIVATE_KEY }}
          script_stop: true
          script: |
            sh /app/hotel-mono-reservation/start_server.sh
            sleep 5
            ps -ef | grep server-api-1.0.0.jar | grep java
